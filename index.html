<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Boba Finder">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Boba Finder</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --bg-card-hover: #1c2a4a;
      --accent: #e94560;
      --accent-glow: rgba(233, 69, 96, 0.3);
      --tea-green: #4ecca3;
      --tea-green-glow: rgba(78, 204, 163, 0.25);
      --pearl: #f5e6ca;
      --pearl-soft: rgba(245, 230, 202, 0.08);
      --text-primary: #f0e6d3;
      --text-secondary: #8b9dc3;
      --text-muted: #5a6a8a;
      --radius: 16px;
      --radius-sm: 10px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ===== SPLASH / LOADING STATE ===== */
    #splash {
      position: fixed; inset: 0; z-index: 1000;
      background: var(--bg-dark);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }
    #splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

    .splash-icon {
      width: 90px; height: 90px;
      background: linear-gradient(135deg, var(--accent), #ff6b81);
      border-radius: 24px;
      display: flex; align-items: center; justify-content: center;
      font-size: 44px;
      box-shadow: 0 8px 40px var(--accent-glow);
      animation: pulse-icon 1.8s ease-in-out infinite;
      margin-bottom: 28px;
    }
    @keyframes pulse-icon {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .splash-text {
      font-family: 'Fredoka', sans-serif;
      font-size: 26px; font-weight: 700;
      background: linear-gradient(135deg, var(--pearl), var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }
    .splash-sub {
      color: var(--text-secondary); font-size: 14px;
      animation: dot-pulse 1.4s ease-in-out infinite;
    }
    @keyframes dot-pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* ===== APP SHELL ===== */
    #app {
      display: flex; flex-direction: column;
      height: 100dvh;
      opacity: 0;
      transition: opacity 0.5s ease 0.3s;
    }
    #app.visible { opacity: 1; }

    /* ===== HEADER ===== */
    .header {
      padding: 12px 20px;
      display: flex; align-items: center; gap: 12px;
      background: rgba(26, 26, 46, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(245, 230, 202, 0.06);
      z-index: 500;
      flex-shrink: 0;
    }
    .header-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--accent), #ff6b81);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px;
      box-shadow: 0 4px 16px var(--accent-glow);
      flex-shrink: 0;
    }
    .header-text h1 {
      font-family: 'Fredoka', sans-serif;
      font-size: 18px; font-weight: 700;
      color: var(--pearl);
      line-height: 1.2;
    }
    .header-text p {
      font-size: 11.5px; color: var(--text-muted);
      line-height: 1.2;
    }
    .header-refresh {
      margin-left: auto;
      width: 38px; height: 38px;
      background: var(--pearl-soft);
      border: 1px solid rgba(245, 230, 202, 0.1);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.25s ease;
      flex-shrink: 0;
    }
    .header-refresh:hover { background: rgba(245, 230, 202, 0.14); color: var(--pearl); }
    .header-refresh.spinning svg { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== MAP ===== */
    #map {
      flex: 1;
      min-height: 0;
      z-index: 1;
    }

    /* ===== BOTTOM SHEET ===== */
    .sheet {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 600;
      max-height: 52dvh;
      background: rgba(22, 33, 62, 0.96);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border-top: 1px solid rgba(245, 230, 202, 0.08);
      box-shadow: 0 -8px 40px rgba(0,0,0,0.4);
      display: flex; flex-direction: column;
      transform: translateY(calc(100% - 64px));
      transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1);
      touch-action: none;
    }
    .sheet.expanded { transform: translateY(0); }

    .sheet-handle {
      padding: 10px 0 6px;
      display: flex; justify-content: center;
      cursor: grab;
      flex-shrink: 0;
    }
    .sheet-handle span {
      width: 36px; height: 4px;
      background: rgba(245, 230, 202, 0.2);
      border-radius: 2px;
    }

    .sheet-header {
      padding: 4px 20px 12px;
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .sheet-header h2 {
      font-family: 'Fredoka', sans-serif;
      font-size: 16px; font-weight: 600;
      color: var(--pearl);
    }
    .sheet-count {
      font-size: 12px;
      background: var(--accent);
      color: white;
      padding: 2px 10px;
      border-radius: 20px;
      font-weight: 600;
    }

    .sheet-list {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 16px 32px;
      flex: 1;
    }

    /* ===== PLACE CARD ===== */
    .place-card {
      background: rgba(245, 230, 202, 0.04);
      border: 1px solid rgba(245, 230, 202, 0.07);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex; gap: 14px; align-items: flex-start;
    }
    .place-card:hover, .place-card:active {
      background: rgba(245, 230, 202, 0.08);
      border-color: rgba(233, 69, 96, 0.3);
    }
    .place-card.active {
      border-color: var(--accent);
      background: rgba(233, 69, 96, 0.08);
    }

    .place-rank {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--accent), #ff6b81);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Fredoka', sans-serif;
      font-size: 14px; font-weight: 700;
      color: white;
      flex-shrink: 0;
      box-shadow: 0 2px 10px var(--accent-glow);
    }

    .place-info { flex: 1; min-width: 0; }
    .place-name {
      font-family: 'Fredoka', sans-serif;
      font-size: 14.5px; font-weight: 600;
      color: var(--pearl);
      margin-bottom: 4px;
      line-height: 1.3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .place-meta {
      display: flex; align-items: center; gap: 10px;
      flex-wrap: wrap;
    }
    .place-rating {
      display: flex; align-items: center; gap: 4px;
      font-size: 12.5px; font-weight: 600;
      color: #fbbf24;
    }
    .place-distance {
      font-size: 12px; color: var(--tea-green);
      font-weight: 500;
    }
    .place-hours {
      font-size: 11.5px;
      color: var(--text-muted);
    }
    .place-hours.open { color: var(--tea-green); }
    .place-hours.closed { color: var(--accent); }

    .place-addr {
      font-size: 11.5px;
      color: var(--text-muted);
      margin-top: 4px;
      line-height: 1.3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .place-nav {
      flex-shrink: 0;
      width: 36px; height: 36px;
      background: var(--tea-green);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      align-self: center;
      box-shadow: 0 2px 10px var(--tea-green-glow);
      transition: transform 0.15s ease;
      text-decoration: none;
    }
    .place-nav:active { transform: scale(0.92); }
    .place-nav svg { width: 18px; height: 18px; stroke: #1a1a2e; fill: none; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }

    /* ===== ERROR STATE ===== */
    .error-card {
      position: fixed; top: 80px; left: 16px; right: 16px;
      background: rgba(233, 69, 96, 0.15);
      border: 1px solid rgba(233, 69, 96, 0.3);
      border-radius: var(--radius-sm);
      padding: 14px 18px;
      z-index: 800;
      font-size: 13.5px;
      color: #ff8fa3;
      text-align: center;
      animation: slide-down 0.4s ease;
    }
    @keyframes slide-down {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== LEAFLET CUSTOM ===== */
    .leaflet-control-zoom { border: none !important; }
    .leaflet-control-zoom a {
      background: rgba(22, 33, 62, 0.92) !important;
      color: var(--pearl) !important;
      border: 1px solid rgba(245, 230, 202, 0.1) !important;
      backdrop-filter: blur(10px);
      width: 36px !important; height: 36px !important;
      line-height: 36px !important;
      font-size: 18px !important;
      border-radius: 10px !important;
      margin-bottom: 4px !important;
    }
    .leaflet-control-attribution { display: none !important; }

    .user-marker {
      width: 20px; height: 20px;
      background: #4f8cff;
      border: 3px solid white;
      border-radius: 50%;
      box-shadow: 0 0 0 6px rgba(79, 140, 255, 0.25), 0 2px 8px rgba(0,0,0,0.3);
      animation: user-pulse 2.5s ease-in-out infinite;
    }
    @keyframes user-pulse {
      0%, 100% { box-shadow: 0 0 0 6px rgba(79, 140, 255, 0.25), 0 2px 8px rgba(0,0,0,0.3); }
      50% { box-shadow: 0 0 0 14px rgba(79, 140, 255, 0.08), 0 2px 8px rgba(0,0,0,0.3); }
    }

    .boba-marker {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), #ff6b81);
      border-radius: 50% 50% 50% 4px;
      transform: rotate(-45deg);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 3px 14px var(--accent-glow);
      border: 2px solid rgba(255,255,255,0.25);
      transition: transform 0.2s ease;
    }
    .boba-marker span {
      transform: rotate(45deg);
      font-size: 16px;
    }
    .boba-marker.top-rated {
      background: linear-gradient(135deg, var(--tea-green), #2ecc71);
      box-shadow: 0 3px 14px var(--tea-green-glow);
    }

    .leaflet-popup-content-wrapper {
      background: rgba(22, 33, 62, 0.95) !important;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(245, 230, 202, 0.1) !important;
      border-radius: 12px !important;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4) !important;
      color: var(--pearl) !important;
      padding: 0 !important;
    }
    .leaflet-popup-tip { background: rgba(22, 33, 62, 0.95) !important; }
    .leaflet-popup-content {
      margin: 12px 16px !important;
      font-family: 'DM Sans', sans-serif !important;
      font-size: 13px !important;
      line-height: 1.5 !important;
    }
    .popup-name {
      font-family: 'Fredoka', sans-serif;
      font-size: 14px; font-weight: 600;
      margin-bottom: 4px;
    }
    .popup-rating { color: #fbbf24; font-size: 12px; }
    .popup-addr { color: var(--text-muted); font-size: 11.5px; margin-top: 2px; }

    /* Safe area for notch phones */
    @supports (padding-top: env(safe-area-inset-top)) {
      .header { padding-top: calc(12px + env(safe-area-inset-top)); }
      .sheet-list { padding-bottom: calc(32px + env(safe-area-inset-bottom)); }
    }
  </style>
</head>
<body>

  <!-- Splash Screen -->
  <div id="splash">
    <div class="splash-icon">üßã</div>
    <div class="splash-text">Boba Finder</div>
    <div class="splash-sub">Finding your location‚Ä¶</div>
  </div>

  <!-- App -->
  <div id="app">
    <div class="header">
      <div class="header-icon">üßã</div>
      <div class="header-text">
        <h1>Boba Finder</h1>
        <p id="location-label">Searching nearby‚Ä¶</p>
      </div>
      <button class="header-refresh" id="refreshBtn" title="Refresh">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
      </button>
    </div>
    <div id="map"></div>

    <!-- Bottom Sheet -->
    <div class="sheet" id="sheet">
      <div class="sheet-handle" id="sheetHandle"><span></span></div>
      <div class="sheet-header">
        <h2>Nearby Boba</h2>
        <span class="sheet-count" id="placeCount">0</span>
      </div>
      <div class="sheet-list" id="placeList"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

  <script>
    // ===== CONFIG =====
    const SEARCH_RADIUS = 5000; // meters

    let map, userLat, userLng;
    let markers = [];
    let places = [];

    // ===== INIT =====
    async function init() {
      try {
        const pos = await getLocation();
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;

        hideSplash();
        initMap();
        addUserMarker();
        await findBoba();
      } catch (err) {
        hideSplash();
        initMap(36.1069, -115.1775); // Fallback: Las Vegas
        showError(getLocationError(err));
      }
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject({ code: 0, message: 'Geolocation not supported' });
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 60000
        });
      });
    }

    function getLocationError(err) {
      switch (err.code) {
        case 1: return 'Location access denied. Please enable GPS in your settings.';
        case 2: return 'Unable to determine your position. Please try again.';
        case 3: return 'Location request timed out. Check your GPS signal.';
        default: return 'Geolocation is not supported on this device.';
      }
    }

    // ===== MAP =====
    function initMap(lat, lng) {
      const center = [lat || userLat, lng || userLng];
      map = L.map('map', {
        center, zoom: 14,
        zoomControl: true,
        attributionControl: false
      });

      // Dark tile layer
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        subdomains: 'abcd'
      }).addTo(map);

      if (!lat) {
        document.getElementById('location-label').textContent =
          `${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
      }
    }

    function addUserMarker() {
      const icon = L.divIcon({
        className: '',
        html: '<div class="user-marker"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      L.marker([userLat, userLng], { icon, zIndexOffset: 1000 })
        .addTo(map)
        .bindPopup('<div class="popup-name">üìç You are here</div>');
    }

    // ===== BOBA SEARCH =====
    const OVERPASS_ENDPOINTS = [
      'https://overpass-api.de/api/interpreter',
      'https://overpass.kumi.systems/api/interpreter',
      'https://maps.mail.ru/osm/tools/overpass/api/interpreter'
    ];

    async function findBoba() {
      document.getElementById('location-label').textContent = 'Searching for boba‚Ä¶';
      let found = await tryOverpass();
      if (!found) {
        found = await tryNominatim();
      }
      if (found && places.length > 0) {
        renderPlaces();
        renderMarkers();
        fitBounds();
        reverseGeocode();
      } else if (places.length === 0) {
        showError('No boba places found nearby. Try searching "boba near me" in Google Maps!');
        document.getElementById('placeCount').textContent = '0';
        reverseGeocode();
      }
    }

    async function tryOverpass() {
      const query = `[out:json][timeout:15];(node["cuisine"~"bubble_tea|boba"](around:${SEARCH_RADIUS},${userLat},${userLng});node["drink"~"bubble_tea|boba"](around:${SEARCH_RADIUS},${userLat},${userLng});node["name"~"boba|bubble tea|milk tea|kung fu tea|happy lemon|gong cha|tea bar|tiger sugar|the alley|coco|onezo|tpumps|boba guys|boba tea|tea house",i]["amenity"~"cafe|restaurant|fast_food"](around:${SEARCH_RADIUS},${userLat},${userLng});node["name"~"boba|bubble tea|milk tea",i]["shop"](around:${SEARCH_RADIUS},${userLat},${userLng});way["cuisine"~"bubble_tea|boba"](around:${SEARCH_RADIUS},${userLat},${userLng});way["name"~"boba|bubble tea|milk tea|kung fu tea|happy lemon|gong cha|tea bar|tiger sugar",i]["amenity"~"cafe|restaurant|fast_food"](around:${SEARCH_RADIUS},${userLat},${userLng}););out center body;`;

      for (const endpoint of OVERPASS_ENDPOINTS) {
        try {
          const url = endpoint + '?data=' + encodeURIComponent(query);
          const resp = await fetch(url);
          if (!resp.ok) continue;
          const data = await resp.json();
          places = (data.elements || [])
            .map(el => {
              const lat = el.lat || el.center?.lat;
              const lng = el.lon || el.center?.lon;
              if (!lat || !lng) return null;
              return {
                name: el.tags?.name || 'Boba Shop',
                lat, lng,
                addr: [el.tags?.['addr:housenumber'], el.tags?.['addr:street'], el.tags?.['addr:city']].filter(Boolean).join(' ') || '',
                dist: haversine(userLat, userLng, lat, lng),
                hours: el.tags?.opening_hours || '',
                phone: el.tags?.phone || el.tags?.['contact:phone'] || '',
                website: el.tags?.website || el.tags?.['contact:website'] || ''
              };
            })
            .filter(Boolean)
            .sort((a, b) => a.dist - b.dist)
            .slice(0, 20);
          return true;
        } catch (e) {
          console.warn('Overpass endpoint failed:', endpoint, e);
          continue;
        }
      }
      return false;
    }

    async function tryNominatim() {
      try {
        const searches = ['boba tea', 'bubble tea', 'milk tea'];
        const allResults = [];
        for (const term of searches) {
          try {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(term)}&format=json&limit=10&viewbox=${userLng-0.05},${userLat+0.05},${userLng+0.05},${userLat-0.05}&bounded=1`;
            const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (!resp.ok) continue;
            const data = await resp.json();
            allResults.push(...data);
          } catch(e) { continue; }
        }
        const seen = new Set();
        places = allResults
          .map(r => {
            const lat = parseFloat(r.lat);
            const lng = parseFloat(r.lon);
            const key = r.display_name + lat.toFixed(4);
            if (seen.has(key)) return null;
            seen.add(key);
            const name = r.display_name.split(',')[0];
            const addr = r.display_name.split(',').slice(1, 3).join(',').trim();
            return { name, lat, lng, addr, dist: haversine(userLat, userLng, lat, lng), hours: '', phone: '', website: '' };
          })
          .filter(Boolean)
          .filter(p => p.dist <= SEARCH_RADIUS)
          .sort((a, b) => a.dist - b.dist)
          .slice(0, 20);
        return true;
      } catch (err) {
        console.error('Nominatim failed:', err);
        showError('Could not search for boba places. Check your internet connection.');
        return false;
      }
    }

    // ===== RENDERING =====
    function renderPlaces() {
      const list = document.getElementById('placeList');
      document.getElementById('placeCount').textContent = places.length;

      list.innerHTML = places.map((p, i) => `
        <div class="place-card" data-idx="${i}" onclick="focusPlace(${i})">
          <div class="place-rank">${i + 1}</div>
          <div class="place-info">
            <div class="place-name">${esc(p.name)}</div>
            <div class="place-meta">
              <span class="place-distance">${formatDist(p.dist)}</span>
              ${p.hours ? `<span class="place-hours">${esc(p.hours)}</span>` : ''}
            </div>
            ${p.addr ? `<div class="place-addr">${esc(p.addr)}</div>` : ''}
          </div>
          <a class="place-nav" href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}&travelmode=walking" target="_blank" rel="noopener" onclick="event.stopPropagation()">
            <svg viewBox="0 0 24 24"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
          </a>
        </div>
      `).join('');
    }

    function renderMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      places.forEach((p, i) => {
        const isTop = i < 3;
        const icon = L.divIcon({
          className: '',
          html: `<div class="boba-marker ${isTop ? 'top-rated' : ''}"><span>üßã</span></div>`,
          iconSize: [36, 36],
          iconAnchor: [18, 36],
          popupAnchor: [0, -36]
        });
        const m = L.marker([p.lat, p.lng], { icon })
          .addTo(map)
          .bindPopup(`
            <div class="popup-name">${esc(p.name)}</div>
            <div class="popup-addr">${formatDist(p.dist)} away${p.addr ? ' ¬∑ ' + esc(p.addr) : ''}</div>
          `);
        m.on('click', () => highlightCard(i));
        markers.push(m);
      });
    }

    function fitBounds() {
      if (places.length === 0) return;
      const pts = [[userLat, userLng], ...places.map(p => [p.lat, p.lng])];
      map.fitBounds(pts, { padding: [50, 50], maxZoom: 15 });
    }

    function focusPlace(i) {
      const p = places[i];
      map.flyTo([p.lat, p.lng], 16, { duration: 0.8 });
      markers[i].openPopup();
      highlightCard(i);
    }

    function highlightCard(i) {
      document.querySelectorAll('.place-card').forEach(c => c.classList.remove('active'));
      const card = document.querySelector(`.place-card[data-idx="${i}"]`);
      if (card) {
        card.classList.add('active');
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    // ===== BOTTOM SHEET GESTURE =====
    const sheet = document.getElementById('sheet');
    const handle = document.getElementById('sheetHandle');
    let sheetExpanded = false;

    handle.addEventListener('click', () => {
      sheetExpanded = !sheetExpanded;
      sheet.classList.toggle('expanded', sheetExpanded);
    });

    // Touch drag
    let startY = 0, sheetTranslate = 0;
    handle.addEventListener('touchstart', e => {
      startY = e.touches[0].clientY;
      sheet.style.transition = 'none';
    }, { passive: true });
    handle.addEventListener('touchmove', e => {
      const dy = e.touches[0].clientY - startY;
      if (sheetExpanded) {
        sheet.style.transform = `translateY(${Math.max(0, dy)}px)`;
      } else {
        const base = sheet.offsetHeight - 64;
        sheet.style.transform = `translateY(${Math.max(0, base + dy)}px)`;
      }
    }, { passive: true });
    handle.addEventListener('touchend', e => {
      sheet.style.transition = '';
      const dy = e.changedTouches[0].clientY - startY;
      if (sheetExpanded && dy > 80) {
        sheetExpanded = false;
        sheet.classList.remove('expanded');
      } else if (!sheetExpanded && dy < -50) {
        sheetExpanded = true;
        sheet.classList.add('expanded');
      }
      sheet.style.transform = '';
    });

    // ===== REFRESH =====
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      const btn = document.getElementById('refreshBtn');
      btn.classList.add('spinning');
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      places = [];

      try {
        const pos = await getLocation();
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        map.setView([userLat, userLng], 14);
        addUserMarker();
        await findBoba();
      } catch (err) {
        showError(getLocationError(err));
      }
      btn.classList.remove('spinning');
    });

    // ===== HELPERS =====
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function formatDist(m) {
      if (m < 1000) return Math.round(m) + 'm';
      return (m / 1609.34).toFixed(1) + ' mi';
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function hideSplash() {
      document.getElementById('splash').classList.add('hidden');
      document.getElementById('app').classList.add('visible');
    }

    function showError(msg) {
      const existing = document.querySelector('.error-card');
      if (existing) existing.remove();
      const el = document.createElement('div');
      el.className = 'error-card';
      el.textContent = msg;
      document.getElementById('app').appendChild(el);
      setTimeout(() => el.remove(), 8000);
    }

    async function reverseGeocode() {
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLat}&lon=${userLng}&format=json&zoom=16`);
        const data = await resp.json();
        const parts = [];
        if (data.address) {
          const a = data.address;
          if (a.neighbourhood || a.suburb) parts.push(a.neighbourhood || a.suburb);
          if (a.city || a.town) parts.push(a.city || a.town);
        }
        if (parts.length) {
          document.getElementById('location-label').textContent = parts.join(', ');
        }
      } catch(e) {}
    }

    // ===== SERVICE WORKER =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }

    // Start
    init();
  </script>
</body>
</html>
